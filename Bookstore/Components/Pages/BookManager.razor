@page "/bookmanager"
@using System.Globalization;
@using Bookstore.Data; 
 
@inject BookService _bookService // Injects the BookService to enable database operations.

<PageTitle>Book Manager</PageTitle>

<div class="container my-4">
    <h1 class="display-4 text-primary mb-4">
       Book Management Page
    </h1>

    @* Displays status/error messages if StatusMessage is not empty. *@
    @if (!string.IsNullOrEmpty(StatusMessage))
    {
        <div class="@StatusClass alert alert-dismissible fade show" role="alert">@StatusMessage</div>
    }

    <div class="row">

        @* LEFT COLUMN: Forms (Add/Edit and Date Filter) *@
        <div class="col-lg-4 mb-4">

            @* Card for Adding or Editing a Book *@
            <div class="card shadow mb-4">
                <div class="card-body">
                    <h2 class="card-title h5">@(IsEditing ? "Edit Book" : "Add New Book")</h2>
                    @* EditForm handles form submission and validation. OnValidSubmit calls the async SaveBook method. *@
                    <EditForm Model="CurrentBook" OnValidSubmit="SaveBook" class="needs-validation" Novalidate>
                        <DataAnnotationsValidator />
                        
                        @* Hidden field for the primary key (BookId), necessary for updates. *@
                        <InputNumber @bind-Value="CurrentBook.BookId" hidden /> 

                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <InputText id="title" @bind-Value="CurrentBook.Title" required class="form-control" />
                            <ValidationMessage For="@(() => CurrentBook.Title)" />
                        </div>

                        <div class="mb-3">
                            <label for="author" class="form-label">Author</label>
                            <InputText id="author" @bind-Value="CurrentBook.Author" required class="form-control" />
                            <ValidationMessage For="@(() => CurrentBook.Author)" />
                        </div>

                        <div class="mb-3">
                            <label for="isbn" class="form-label">ISBN</label>
                            <InputText id="isbn" @bind-Value="CurrentBook.ISBN" required class="form-control" />
                            <ValidationMessage For="@(() => CurrentBook.ISBN)" />
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <button type="submit" class="btn btn-primary flex-fill">
                                @(IsEditing ? "Save Changes" : "Insert Book")
                            </button>
                            @if (IsEditing)
                            {
                                <button type="button" @onclick="ResetForm" class="btn btn-secondary">
                                    Cancel Edit
                                </button>
                            }
                        </div>
                    </EditForm>
                </div>
            </div>

            @* Card for Loan Date Filter *@
            <div class="card shadow">
                <div class="card-body">
                    <h2 class="card-title h5">Loan Query</h2>
                    <p class="card-text text-muted small">Filters borrowed books within the period.</p>
                    @* @onsubmit calls the async FilterByDateRange method to query the DB *@
                    <form @onsubmit="FilterByDateRange"> 
                        <div class="mb-3">
                            <label for="start-date" class="form-label">Start Date</label>
                            <input type="date" @bind="FilterStartDate" required class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="end-date" class="form-label">End Date</label>
                            <input type="date" @bind="FilterEndDate" required class="form-control">
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <button type="submit" class="btn btn-success flex-fill">
                                Apply Date Filter
                            </button>
                            @if (IsFiltered)
                            {
                                @* Button to remove filter and reload all books *@
                                <button type="button" @onclick="ClearFilter" class="btn btn-danger">
                                    Clear Filter
                                </button>
                            }
                        </div>
                    </form>
                </div>
            </div>

        </div>

        @* RIGHT COLUMN: Book List Display *@
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-body">
                    <h2 class="card-title h5">Registered Books</h2>
                    <div class="list-group list-group-flush">
                        @* Shows loading indicator while data is being fetched (AllBooks is null) *@
                        @if (AllBooks == null) 
                        {
                            <p class="text-center text-muted p-3 bg-light rounded">Loading books from database...</p>
                        }
                        @* Shows message if the list is empty *@
                        else if (!AllBooks.Any())
                        {
                            <p class="text-center text-muted p-3 bg-light rounded">No books found.</p>
                        }
                        else
                        {
                            @* Iterate over the list of books loaded from the database service *@
                            @foreach (var book in AllBooks)
                            {
                                @* Status and display variables *@
                                var statusBadgeClass = book.IsAvailable ? "bg-success" : "bg-danger";
                                var statusText = book.IsAvailable ? "Available" : $"Loaned to {book.BorrowerName ?? "unknown"}";
                                var actionButtonClass = book.IsAvailable ? "btn-warning" : "btn-info";
                                var actionButtonText = book.IsAvailable ? "Borrow" : "Return";
                                var borrowDateDisplay = book.BorrowDate.HasValue ? book.BorrowDate.Value.ToString("dd/MM/yyyy HH:mm:ss") : "N/A";

                                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start my-2 p-3 shadow-sm rounded">
                                    <div>
                                        <p class="h6 mb-1">@book.Title</p>
                                        <p class="small text-muted mb-2">by @book.Author</p>
                                        
                                        <div class="small text-secondary mb-3">
                                            <p class="mb-0"><strong>ISBN:</strong> @book.ISBN</p>
                                            <p class="mb-0"><strong>Borrowed on:</strong> @borrowDateDisplay</p>
                                        </div>
                                        
                                        <div class="d-flex gap-2">
                                            @* Edit button: loads data into the form. *@
                                            <button @onclick="(() => LoadBookForEdit(book))" class="btn btn-sm btn-secondary">Edit</button>
                                            @* Borrow/Return button: calls the async ToggleBorrowStatus method. *@
                                            <button @onclick="(() => ToggleBorrowStatus(book))" class="btn btn-sm @actionButtonClass">
                                                @actionButtonText
                                            </button>
                                            @* Delete button: calls the async DeleteBook method. *@
                                            <button @onclick="(() => DeleteBook(book.BookId))" class="btn btn-sm btn-danger">Delete</button>
                                        </div>
                                    </div>
                                    
                                    <span class="badge @statusBadgeClass rounded-pill">@statusText</span>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // List to hold the books loaded from the database.
    private List<Book>? AllBooks; 
    // The book entity currently bound to the EditForm.
    private Book CurrentBook = new Book();
    private bool IsEditing = false;
    private string StatusMessage = string.Empty;
    private string StatusClass = string.Empty;

    // State for the Date Filter
    private DateTime? FilterStartDate { get; set; } = null;
    private DateTime? FilterEndDate { get; set; } = null;
    // Checks if both filter dates have values.
    private bool IsFiltered => FilterStartDate.HasValue && FilterEndDate.HasValue;
    
    // --- Component Lifecycle (Async) ---

    // Initializes the component by asynchronously loading book data.
    protected override async Task OnInitializedAsync()
    {
        await LoadBooksAsync();
    }

    // --- Data Loading Logic ---

    // Main method to fetch or reload the book list from the service.
    private async Task LoadBooksAsync(bool forceReload = true)
    {
        if (forceReload)
        {
            AllBooks = null; // Set to null to show the loading state.
            StateHasChanged();
        }
        
        try
        {
            // CALLS THE SERVICE: Reads all books from the database asynchronously.
            AllBooks = await _bookService.GetBooksAsync();
        }
        catch (Exception ex)
        {
            SetStatus($"Error loading books: {ex.Message}", "red");
            AllBooks = new List<Book>(); // Initialize empty list on failure.
        }
        finally
        {
            StateHasChanged(); // Triggers a UI re-render.
        }
    }

    // --- Status Logic ---

    private void SetStatus(string message, string type)
    {
        StatusMessage = message;
        // Map custom color names to Bootstrap Alert classes.
        string alertType = type switch
        {
            "green" => "alert-success",
            "red" => "alert-danger",
            "blue" => "alert-info",
            "orange" => "alert-warning",
            _ => "alert-secondary",
        };
        StatusClass = alertType;
    }

    // --- Filtering and Query Logic (Using BookService) ---

    // Executes the date range query.
    private async Task FilterByDateRange()
    {
        if (FilterStartDate.HasValue && FilterEndDate.HasValue)
        {
            try
            {
                // CALLS THE SERVICE: Filters borrowed books within the date range in the database.
                AllBooks = await _bookService.GetBooksBorrowedInDateRangeAsync(FilterStartDate.Value, FilterEndDate.Value);
                SetStatus($"ACTIVE Loan Filter: {FilterStartDate.Value.ToShortDateString()} to {FilterEndDate.Value.ToShortDateString()}", "green");
            }
            catch (Exception ex)
            {
                SetStatus($"Error applying filter: {ex.Message}", "red");
            }
        }
    }

    // Clears the date filters and reloads the full book list.
    private async Task ClearFilter()
    {
        FilterStartDate = null;
        FilterEndDate = null;
        await LoadBooksAsync(false); // Reloads all books
        SetStatus("Date filter removed.", "blue");
    }

    // --- CRUD Methods (Using BookService) ---

    // Handles both CREATE (Insert) and UPDATE (Save Edit) operations.
    private async Task SaveBook()
    {
        try
        {
            if (IsEditing)
            {
                // CALLS THE SERVICE: Updates existing book details in the database.
                await _bookService.UpdateBookDetailsAsync(CurrentBook);
                SetStatus("Book details updated!", "green");
            }
            else
            {
                // CALLS THE SERVICE: Inserts a new book into the database.
                await _bookService.AddBookAsync(CurrentBook);
                SetStatus("Book inserted successfully!", "green");
            }
        }
        catch (Exception ex)
        {
            SetStatus($"Error saving book: {ex.Message}", "red");
        }
        
        ResetForm();
        await LoadBooksAsync(false); // Reloads the list to show changes.
    }

    // Loads the selected book's data into the CurrentBook form model for editing.
    private void LoadBookForEdit(Book bookToEdit)
    {
        // Creates a COPY to prevent direct manipulation of the list item before saving.
        CurrentBook = new Book
        {
            BookId = bookToEdit.BookId,
            Title = bookToEdit.Title,
            Author = bookToEdit.Author,
            ISBN = bookToEdit.ISBN,
            IsAvailable = bookToEdit.IsAvailable,
            BorrowerName = bookToEdit.BorrowerName,
            BorrowDate = bookToEdit.BorrowDate
        };
        IsEditing = true;
    }

    // Handles the DELETE operation.
    private async Task DeleteBook(int bookId)
    {
        try
        {
            // CALLS THE SERVICE: Deletes the book from the database.
            await _bookService.DeleteBookAsync(bookId);
            SetStatus("Book deleted successfully!", "red");
        }
        catch (Exception ex)
        {
            SetStatus($"Error deleting book: {ex.Message}", "red");
        }
        
        await LoadBooksAsync(false); // Reloads the list.
    }

    // Handles the transaction (Borrow/Return) UPDATE operation.
    private async Task ToggleBorrowStatus(Book book)
    {
        try
        {
            if (book.IsAvailable)
            {
                // CALLS THE SERVICE: Borrows the book.
                var borrowerName = $"User #{new Random().Next(100)}";
                await _bookService.BorrowAsync(book.BookId, borrowerName);
                SetStatus($"Book borrowed by {borrowerName}!", "orange");
            }
            else
            {
                // CALLS THE SERVICE: Returns the book.
                await _bookService.ReturnAsync(book.BookId);
                SetStatus("Book returned successfully!", "blue");
            }
        }
        catch (InvalidOperationException ex)
        {
            // Captures business logic errors (e.g., already borrowed/returned).
            SetStatus($"Error: {ex.Message}", "red");
        }
        catch (Exception ex)
        {
            SetStatus($"An unexpected error occurred: {ex.Message}", "red");
        }
        
        await LoadBooksAsync(false); // Reloads the list to reflect the new status.
    }

    // --- Form Utility Functions ---

    // Resets the form model and editing state.
    private void ResetForm()
    {
        CurrentBook = new Book();
        IsEditing = false;
        StateHasChanged();
    }
}